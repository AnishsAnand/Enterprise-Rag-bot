<div class="rag-widget" [class.expanded]="isExpanded" [attr.aria-hidden]="!isExpanded">
  <button class="widget-toggle" (click)="toggleWidget()" title="Open chat" aria-label="Open chat">
    <span class="toggle-icon">üí¨</span>
  </button>

  <div class="widget-content" *ngIf="isExpanded" role="dialog" aria-label="Chat widget">
    <header class="widget-header">
      <div class="header-left">
        <div class="header-icon">üë§</div>
        <div class="header-text">
          <div class="header-title">Enterprise RAG Bot</div>
          <div class="header-sub">support</div>
        </div>
      </div>
      <button class="header-close" (click)="toggleWidget()" aria-label="Close">‚úï</button>
    </header>

    <div class="widget-tab-section">
      <div class="tab-header">Chat</div>
      <div class="tab-underline"></div>
    </div>

    <main class="widget-body">
      <div #chatMessages class="chat-messages" role="log" aria-live="polite">
        <div *ngFor="let m of messages; let mi = index; trackBy: trackByIndex" class="message-group" [ngClass]="m.from">
          <!-- System title -->
          <div *ngIf="m.from === 'system' && !m.steps?.length && !m.summary?.length" class="system-title">
            {{ m.text }}
          </div>

          <!-- Regular messages (without steps/summary) -->
          <div *ngIf="!m.steps?.length && !m.summary?.length && m.from !== 'system'" class="message-row">
            <div class="bubble" [ngClass]="m.from">
              <div class="bubble-text">{{ m.text }}</div>
            </div>

            <!-- Images gallery for non-step messages -->
            <div class="images-gallery" *ngIf="m.images?.length">
              <div *ngFor="let img of m.images" class="gallery-item" (click)="openImage(img)" tabindex="0" (keydown.enter)="openImage(img)">
                <img [src]="img" alt="Message image" (error)="onImageError($event)" loading="lazy" />
              </div>
            </div>

            <div class="message-meta" *ngIf="m.ts">{{ formatTimestamp(m.ts) }}</div>
          </div>

          <!-- Steps section with INLINE images per step -->
          <div *ngIf="m.steps?.length" class="steps-section">
            <div class="steps-card">
              <div class="steps-header">
                <div class="steps-header-left">
                  <div class="steps-title">{{ m.text }}</div>
                </div>
              </div>

              <div class="steps-body">
                <div class="timeline-track" aria-hidden="true"></div>

                <ol class="steps-list">
                  <li *ngFor="let s of m.steps; let i = index" class="step-item">
                    <div class="step-marker">
                      <div class="step-number">{{ s.index ?? (i + 1) }}</div>
                    </div>

                    <div class="step-main">
                      <div class="step-text">{{ s.text }}</div>

                      <!-- Inline image for THIS step -->
                      <div class="step-image-container" *ngIf="s.image">
                        <img [src]="s.image"
                             [alt]="'Step ' + (s.index ?? (i + 1)) + ' image'"
                             (error)="onImageError($event)"
                             (click)="openImage(s.image)"
                             role="button"
                             tabindex="0"
                             (keydown.enter)="openImage(s.image)"
                             loading="lazy" />
                        <div *ngIf="s.caption" class="step-caption">{{ s.caption }}</div>
                      </div>
                    </div>
                  </li>
                </ol>
              </div>

              <div class="steps-footer" *ngIf="m.ts">{{ formatTimestamp(m.ts) }}</div>
            </div>
          </div>

          <!-- Summary section -->
          <div *ngIf="m.summary?.length" class="summary-section">
            <div class="summary-card">
              <div class="summary-header">
                <span class="summary-icon">‚ò∞</span>
                <div class="summary-title">{{ m.summaryTitle || 'Quick Summary' }}</div>
              </div>

              <div class="summary-content">
                <div *ngFor="let item of m.summary; let si = index" class="summary-item">
                  <p class="summary-text">{{ item.content }}</p>

                  <ul *ngIf="item.bullets?.length" class="summary-bullets">
                    <li *ngFor="let b of item.bullets">{{ b }}</li>
                  </ul>
                </div>
              </div>

              <div class="summary-ts">{{ formatTimestamp(m.ts) }}</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="widget-footer" role="contentinfo">
      <form (ngSubmit)="send()" [formGroup]="chatForm" class="chat-form" role="search" autocomplete="off">
        <input type="text"
               placeholder="Ask a question..."
               formControlName="query"
               [disabled]="loading"
               aria-label="Chat input"
               autocomplete="off" />
        <button type="submit" [disabled]="loading || chatForm.invalid" aria-label="Send message" class="send-btn">
          <span *ngIf="!loading">‚§¥</span>
          <span *ngIf="loading">‚è≥</span>
        </button>
      </form>
    </footer>
  </div>
</div>
